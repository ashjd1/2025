pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/ashjd1/2025.git'
        REPO_DIR = '2025'
        PROJECT_DIR = "${WORKSPACE}/2025/devops/project"
        PEM_FILE = "${WORKSPACE}/2025/devops/on-laptop-pem-key.pem"
    }

    stages {
        stage('Clone Repository') {
            steps {
                echo 'ðŸ“¥ Cloning GitHub Repository...'
                sh 'rm -rf 2025' // Clean up old copy if it exists
                sh 'git clone https://github.com/ashjd1/2025.git'
            }
        }

        // stage('Install Dependencies') {
        //     steps {
        //         echo 'ðŸ”§ Installing Git, Terraform, Ansible...'
        //         sh '''
        //         sudo apt-get update -y
        //         sudo apt-get install -y git unzip curl python3-pip software-properties-common
        //         sudo apt-add-repository --yes --update ppa:ansible/ansible
        //         sudo apt-get install -y ansible jq

        //         if ! command -v terraform >/dev/null; then
        //           curl -fsSL https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip -o terraform.zip
        //           unzip terraform.zip
        //           sudo mv terraform /usr/local/bin/
        //         fi
        //         '''
        //     }
        // }

        stage('Terraform Init & Apply') {
            steps {
                dir("${PROJECT_DIR}/terraform") {
                    echo 'ðŸš€ Initializing Terraform...'
                    sh 'terraform init'

                    echo 'ðŸš€ Applying Terraform to create EC2 instance...'
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Fetch Public IP & Update Inventory') {
            steps {
                dir("${PROJECT_DIR}/terraform") {
                    echo 'ðŸ“¥ Extracting EC2 public IP using grep...'
                    script {
                        // Extract the public IP using grep and sed
                        def ec2_ip = sh(
                            script: "grep -rni '\\\"public_ip\\\":' . | sed -E 's/.*\\\"public_ip\\\": \\\"([0-9.]+)\\\".*/\\1/'",
                            returnStdout: true
                        ).trim()

                        echo "EC2 Public IP: ${ec2_ip}"

                        // Write to inventory.ini
                        def inventoryPath = "${PROJECT_DIR}/ansible/inventory.ini"
                        writeFile file: inventoryPath, text: "[ec2]\n${ec2_ip} ansible_user=ubuntu ansible_ssh_private_key_file=${PEM_FILE}"
                    }
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                dir("${PROJECT_DIR}/ansible") {
                    echo 'ðŸ“¦ Running Ansible Playbook...'
                    sh '''
                    ansible-playbook -i inventory.ini playbook.yml
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'âœ… Pipeline completed.'
        }
    }
}